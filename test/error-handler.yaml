assembly:
  execute:
    - activity-log:
        title: Analytics
        description: Log the path/headers to analytics and full payload upon errors
        content: activity
        error-content: payload

    - operation-switch:
        title: Invoke API
        description: Invoke API for the /routes create/update operations
        case:
          - operations:
              - createRoute
              - updateRoute
            execute:
              - invoke-api:
                  target-url: "http://$(target-host)/services/climbing/$(request.x-flow-testcode)"
                  verb: $(request.verb)   # Takes the verb from the context if not set here.
                  timeout: $(timeout)     # Seconds -- default timeout is 2 min.
                  username: $(username)   # Supersedes (and rewrites) basic auth header if present.
                  password: $(password)   # Supersedes (and rewrites) basic auth header if present.

        catch:
          - errors:
              - response.status == "405"
              - response.status == "406"
            execute:
              - message-mediation:
                  target: context.response
                  value: "{ status: 4xx, message: 'this is an 4xx error' }"
              - throw:
                  value: invoke-error

          - errors:
              - response.status == "400"
            execute:
              - message-mediation:
                  target: context.response
                  value: "{ status: 400, message: 'this is an 400 error' }"
              - throw:
                  value: invoke-error

    - activity-log:
        title: Analytics
        description: Log the path/headers to analytics and full payload upon errors
        content: activity
        error-content: payload

  catch:
    - errors:
        - "context.error === 'invoke-error'"
      execute:
        - response:
            payload: context.response

    - default:
        - message-mediation:
            target: context.response
            value: "{ status: 500, message: 'Internal error. Check with the system logs.' }"
        - response:
            payload: context.response
